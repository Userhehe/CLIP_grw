<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.clip.gwr.model.mapper.AnnualDaoImpl">

  <insert id="insertAnn" parameterType="java.util.Map">
  		<selectKey keyProperty="user_seq" resultType="java.lang.Integer" order="BEFORE">
			SELECT USER_SEQ.NEXTVAL-1 AS USER_SEQ FROM DUAL
		</selectKey>
<!--    INSERT INTO ANNUAL_CT -->
<!-- 	(ANN_SEQ, USER_ID, ANN_DAY, ANN_DATE, ANN_LEOV) -->
<!-- 	VALUES(('ANN_' || TO_CHAR(ANNUALCT_SEQ.NEXTVAL)), #{user_id}, 0,SYSDATE, 0) -->
	   INSERT INTO ANNUAL_CT
		(ANN_SEQ, USER_ID, ANN_DAY, ANN_DATE, ANN_LEOV)
		VALUES(('ANN_' || TO_CHAR(ANNUALCT_SEQ.NEXTVAL)), 'USER_' || TO_CHAR(USER_SEQ.NEXTVAL-1), 0,SYSDATE, 0)
  </insert>
  
  <update id="insertAnnualup" parameterType="java.util.Map">
  <![CDATA[
	UPDATE ANNUAL_CT
	SET ANN_DAY = 1,
    ANN_DATE = SYSDATE,
    ANN_LEOV = (SELECT ANN_DAY FROM ANNUAL_CT WHERE USER_ID = #{user_id}) + 1
	WHERE USER_ID = #{user_id}
	AND (SYSDATE - ANN_DATE) < 365;
	 ]]>
	</update>

	<select id="annAll" resultType="com.clip.gwr.vo.AnnualVo">
	SELECT ac.USER_ID, u.USER_NAME, (ac.ANN_LEOV - au.ANNUSE_DAY) AS ANN_LEOV
	FROM ANNUAL_CT ac
	JOIN ANNUAL_USE au ON ac.USER_ID = au.USER_ID
	JOIN USERINFO u ON ac.USER_ID = u.USER_ID
	</select>
	
	<select id="detailAnn" parameterType="java.lang.String" resultType="com.clip.gwr.vo.AnnualVo">
    SELECT ac.USER_ID, u.USER_NAME, (ac.ANN_LEOV - au.ANNUSE_DAY) AS ANN_LEOV,
           r.RANKS_NAME AS ranks_name, p.POSITIONS_NAME AS positions_name, d.DEPT_NAME AS dept_name
    FROM ANNUAL_CT ac 
    JOIN ANNUAL_USE au ON ac.USER_ID = au.USER_ID 
    JOIN USERINFO u ON ac.USER_ID = u.USER_ID
    LEFT JOIN RANKS r ON u.RANKS_SEQ = r.RANKS_SEQ
    LEFT JOIN POSITIONS p ON u.POSITIONS_SEQ = p.POSITIONS_SEQ
    LEFT JOIN DEPT d ON u.DEPT_SEQ = d.DEPT_SEQ
    WHERE ac.USER_ID = #{user_id}
	</select>
	
	<select id="myAnn" parameterType="java.lang.String" resultType="com.clip.gwr.vo.AnnualVo">
	SELECT ac.USER_ID, u.USER_NAME, (ac.ANN_LEOV - au.ANNUSE_DAY) AS ANN_LEOV,
             au.ANNUSE_DAY AS ANN_USEDAY
    FROM ANNUAL_CT ac 
    JOIN ANNUAL_USE au ON ac.USER_ID = au.USER_ID 
    JOIN USERINFO u ON ac.USER_ID = u.USER_ID
    WHERE ac.USER_ID = #{user_id}
</select>
	
	<update id="updateAnn" parameterType="java.lang.String" >
    UPDATE ANNUAL_CT
    SET ANN_DAY = #{ann_day}, 
    ANN_LEOV = ANN_LEOV + #{ann_day} 
    WHERE USER_ID = #{user_id}
	</update>

     
     <update id="resetAnn" parameterType="java.util.Map">
     <![CDATA[
        UPDATE ANNUAL_CT
        SET ANN_DAY = 15, ANN_DATE = SYSDATE, ANN_LEOV = 15 
        WHERE USER_ID IN (
            SELECT USER_ID
            FROM USERINFO
            WHERE USER_REGDATE <= TRUNC(SYSDATE) - INTERVAL '1' YEAR)
      ]]>
	</update>
	
	<update id="resetAnnualUse"  parameterType="java.util.Map">
	<![CDATA[
	UPDATE ANNUAL_USE
	SET ANNUSE_DAY = 0
	WHERE USER_ID IN (
	    SELECT USER_ID
	    FROM USERINFO
	    WHERE USER_REGDATE <= TRUNC(SYSDATE) - INTERVAL '1' YEAR)
	]]>
	</update>
     
     
     <!-- 결재 요청 창 이동하면서 연차 정보를 가져오는 쿼리 -->
     <select id="chkAnn" parameterType="java.lang.String" resultType="com.clip.gwr.vo.AnnualUseVo">
     SELECT COUNT(*)
	 FROM ANNUAL_USE 
	 WHERE USER_ID =#{user_id}
     </select>
     
    <select id="selAnnLe" parameterType="java.lang.String" resultType="com.clip.gwr.vo.AnnualVo">
    SELECT ANN_LEOV 
	FROM ANNUAL_CT 
	WHERE USER_ID = #{user_id}
    </select>
     
    <insert id="applyAnn" parameterType="java.util.Map">
    INSERT INTO ANNUAL_USE
	(ANNUSE_SEQ, USER_ID, ANNUSE_STARTDATE, ANNUSE_ENDDATE, ANNUSE_DAY, ANNUSE_DATE)
	VALUES(('ANNUSE_' || TO_CHAR(ANNUALCT_SEQ.NEXTVAL)),#{user_id},#{annuse_startdate},#{annuse_enddate},#{annuse_day},SYSDATE)
    </insert>
     
     <select id="selAvaliday" resultType="com.clip.gwr.vo.AnnualVo">
     SELECT (ac.ANN_LEOV-au.ANNUSE_DAY) AS ANN_LEOV
	 FROM ANNUAL_CT ac LEFT JOIN ANNUAL_USE au 
	 ON ac.USER_ID =au.USER_ID 
	 WHERE ac.USER_ID =#{user_id}
     </select>
     
     <update id="applyUpdateAnn" parameterType="java.lang.String">
     UPDATE ANNUAL_USE
	 SET USER_ID=#{user_id}, ANNUSE_STARTDATE=#{annuse_startdate}, ANNUSE_ENDDATE=#{annuse_enddate}, 
	 ANNUSE_DAY=(SELECT ANNUSE_DAY FROM ANNUAL_USE WHERE USER_ID =#{user_id})+1, ANNUSE_DATE=SYSDATE 
	 WHERE USER_ID =#{user_id}
     </update>
     
     <select id="searchAnnual" parameterType="java.util.Map" resultType="com.clip.gwr.vo.AnnualVo">
	    SELECT u.USER_ID, u.USER_NAME, d.DEPT_NAME,
	    p.POSITIONS_NAME,r.RANKS_NAME,(ac.ANN_LEOV - NVL(au.ANNUSE_DAY, 0)) AS ANN_LEOV
		FROM USERINFO u
		JOIN ANNUAL_CT ac ON u.USER_ID = ac.USER_ID
		JOIN DEPT d ON u.DEPT_SEQ = d.DEPT_SEQ
		JOIN POSITIONS p ON u.POSITIONS_SEQ = p.POSITIONS_SEQ
		JOIN RANKS r ON u.RANKS_SEQ = r.RANKS_SEQ
		LEFT JOIN ANNUAL_USE au ON u.USER_ID = au.USER_ID
		WHERE 
	<if test="user_name != null and user_name != ''">
			 u.USER_NAME LIKE '%' || #{user_name} || '%'
		</if>
		<if test="ranks_name != null and ranks_name != ''">
			AND r.RANKS_NAME = #{ranks_name}
		</if>
		<if test="dept_name != null and dept_name != ''">
			AND d.DEPT_NAME = #{dept_name}
		</if>
		<if test="positions_name != null and positions_name != ''">
			AND p.POSITIONS_NAME = #{positions_name}
		</if>
     </select>

</mapper>
