<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.clip.gwr.model.mapper.ReservationDaoImpl">
	<!-- 나의 예약 정보 전체 조회 -->
	<select id="myReservationAll" parameterType="java.lang.String" resultType="ReservationVo">
	    SELECT RE_SEQ, USER_ID, RE_TITLE, 
	    		RE_CONTENT, RE_START, RE_END, 
	    		RE_CREATE, RE_DELFLAG, ME_ROOM, RE_ATTEND 
	   		FROM RESERVATION,
	      	JSON_TABLE(RE_ATTEND, '$.Attend[*]'
	           COLUMNS(
	                    ATDNS VARCHAR2(2000) PATH '$.attend'
	               ))
	   		WHERE RE_DELFLAG = 'N'
	    	AND (RE_START BETWEEN TO_DATE('2024-03-01', 'YYYY-MM-DD') AND TO_DATE('2024-03-29', 'YYYY-MM-DD')
	    	OR RE_END BETWEEN TO_DATE('2024-03-01', 'YYYY-MM-DD') AND TO_DATE('2024-03-31', 'YYYY-MM-DD'))
	    	AND ATDNS = #{user_id}
 	</select>
 	
 	<!-- 예약 등록 -->
 	<insert id="myReservationInsert" parameterType="ReservationVo">
    INSERT INTO RESERVATION(RE_SEQ, USER_ID, RE_TITLE, 
    						RE_CONTENT, RE_START, RE_END, 
    						RE_CREATE, ME_ROOM, RE_ATTEND)
		VALUES('RESERVATION_' || TO_CHAR(RESERVATION_SEQ.NEXTVAL, 'FM000'), #{user_id}, #{re_title}, 
				#{re_content}, TO_DATE('2024-03-01T15:00:00', 'YYYY-MM-DD"T"HH24:MI:SS'), TO_DATE('2024-03-01T16:00:00', 'YYYY-MM-DD"T"HH24:MI:SS'), 
				TO_DATE(SYSDATE, 'YYYY-MM-DD"T"HH24:MI:SS'), #{me_room}, #{re_attend})
	</insert>
	
	<!-- 회의실 리스트 -->
	<select id="selectMeetingRoom" resultType="MeeTingRoomVo">
		SELECT ME_ROOM, ME_ATTEND  
			FROM MEETINGROOM
	</select>
	
	<!-- 회의실 가능 시간 -->
	<select id="selectPossibleMeRoom" parameterType="java.util.Map" resultType="java.lang.String" >
		SELECT TO_DATE(#{re_start}||' 09:00:00', 'YYYY-MM-DD HH24:MI:SS') + (LEVEL - 1)/ 24 AS RE_TIME
			FROM DUAL
			CONNECT BY TO_DATE(#{re_start}||' 09:00:00', 'YYYY-MM-DD HH24:MI:SS') + (LEVEL - 1)/ 24 &lt; TO_DATE(#{re_start}||' 17:00:00', 'YYYY-MM-DD HH24:MI:SS')
			MINUS SELECT RE_START
			FROM RESERVATION
			WHERE ME_ROOM = #{me_room}
			AND RE_START BETWEEN TO_DATE(#{re_start}||' 09:00:00', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE(#{re_start}||' 17:00:00', 'YYYY-MM-DD HH24:MI:SS')
	</select>
	
	<!-- 참석자 jstree -->
	<select id="selectAttends" resultType="java.util.Map">
		SELECT u.USER_ID, u.USER_NAME, d.DEPT_NAME 
			FROM USERINFO u LEFT JOIN DEPT d 
			ON u.DEPT_SEQ = d.DEPT_SEQ
	</select>
	


</mapper>
