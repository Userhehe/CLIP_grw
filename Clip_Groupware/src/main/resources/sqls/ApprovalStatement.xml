<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.clip.gwr.model.mapper.ApprovalDaoImpl">


	<!-- 내가 요청한 결재내역 전체 조회 -->
	<select id="getAllApproval" resultType="ApprovalVo" parameterType="java.lang.String">
        SELECT A.APP_SEQ, APP_TITLE, APP_CONTENT,
		GIAN_SEQ, TO_CHAR(APP_CREATEDATE, 'YYYY/MM/DD HH24:MI:SS') APP_CREATEDATE, APP_DRAFT
		FROM APPROVAL a JOIN (SELECT APP_SEQ 
					FROM (SELECT APP_SEQ ,JSON_VALUE(APP_PAYLINE, '$.writer') JT
										FROM APPROVAL)
					WHERE JT = #{user_id} ) JS
		ON(A.APP_SEQ = JS.APP_SEQ)
		WHERE A.APP_DRAFT != '임시저장'
		ORDER BY APP_CREATEDATE DESC
	</select>


		<!-- 내가/내팀이 참조된 결재내역 전체 조회-->		
	<select id="selectReferApproval" resultType="ApprovalVo" parameterType="java.lang.String">  
	 
	  SELECT A.APP_SEQ, APP_TITLE, APP_CONTENT,
		GIAN_SEQ, TO_CHAR(APP_CREATEDATE, 'YYYY/MM/DD HH24:MI:SS') APP_CREATEDATE, APP_DRAFT
			FROM APPROVAL a ,(
			SELECT APP_SEQ
				FROM APPROVAL a ,JSON_TABLE(A.APP_PAYLINE, '$.reference[*]'
								COLUMNS(
										EMP VARCHAR2(2000) FORMAT JSON PATH '$.emp',
										DEPT VARCHAR2(2000) FORMAT JSON PATH '$.team'
									))
					WHERE INSTR(EMP, #{user_id} ) !=0
					OR	INSTR(DEPT, (SELECT DEPT_SEQ 
									FROM USERINFO u 
									WHERE USER_ID = #{user_id} )) !=0) JS
			WHERE A.APP_SEQ = JS.APP_SEQ
			AND (A.APP_DRAFT IN ('결재완료', '결재대기'))
			ORDER BY A.APP_CREATEDATE DESC
	</select>
	


	<!-- 결재내역 단일 상세 조회 -->
	<select id="getOneApproval" resultType="ApprovalVo" parameterType="java.lang.String">
		SELECT *
	        FROM APPROVAL a 
	        WHERE APP_SEQ = #{appSeq} 
	</select>	



	<!-- 결재 조건별검색 전체리스트 조회 -->

	<select id="conditionSearchApproval" resultType="ApprovalVo" parameterType="java.util.Map">
    SELECT APP_SEQ, APP_TITLE, APP_CONTENT,
           GIAN_SEQ, TO_CHAR(APP_CREATEDATE, 'YYYY/MM/DD HH24:MI:SS') AS APP_CREATEDATE, APP_DRAFT
	    FROM APPROVAL
	   	 WHERE 1=1
	    <if test="title!=null">
	        AND APP_TITLE LIKE '%' || #{title} || '%'
	    </if>
	    <if test="name != null">
	    	AND APP_SEQ  IN (SELECT JS.APP_SEQ
			FROM USERINFO RIGHT JOIN (SELECT APP_SEQ ,JSON_VALUE(APP_PAYLINE, '$.writer') JT
										FROM APPROVAL) JS
			ON (JS.JT = USER_ID)
			WHERE USER_NAME LIKE '%' || #{name} || '%')
	    </if>
	    AND NOT(APP_DRAFT = '임시저장' OR APP_DRAFT = '결재취소')
	    ORDER BY APP_CREATEDATE DESC
	</select>



	<!-- 임시저장한 결재리스트 조회 -->
	
	
	<select id="getTempApproval" parameterType="java.lang.String" resultType="ApprovalVo">
		SELECT a.APP_SEQ, APP_TITLE, APP_CONTENT,
           		GIAN_SEQ, TO_CHAR(APP_CREATEDATE, 'YYYY/MM/DD HH24:MI:SS') AS APP_CREATEDATE, APP_DRAFT
		FROM APPROVAL a JOIN (SELECT APP_SEQ
								FROM (SELECT APP_SEQ ,JSON_VALUE(APP_PAYLINE, '$.writer') JT
											FROM APPROVAL)
								WHERE JT = #{user_id} ) JS
		ON (A.APP_SEQ = JS.APP_SEQ)
		AND A.APP_DRAFT = '임시저장'
	</select>
	
	



	<!-- 날짜 지정에따른 결재 신청 -->
	<insert id="reqDynamicDateApproval" parameterType="ApprovalVo">
    INSERT INTO APPROVAL
        (APP_SEQ, APP_TITLE, APP_CONTENT,
        GIAN_SEQ, APP_PAYLINE, APP_STRDATE,
        APP_ENDDATE)
    VALUES('APPROVAL_' || TO_CHAR(APPROVAL_SEQ.NEXTVAL, 'FM000'), #{app_Title}, #{app_Content},
        #{gian_Seq}, #{app_Payline},
        <choose>
            <!-- 만약 시작 날짜와 끝 날짜가 모두 존재하는 경우 -->
            <when test="app_Strdate != null and app_Enddate != null">
                TO_DATE( #{app_Strdate}, 'YYYY-MM-DD HH24:MI:SS'),
                TO_DATE( #{app_Enddate}, 'YYYY-MM-DD HH24:MI:SS')
            </when>
            <!-- 만약 시작 날짜와 끝 날짜가 모두 존재하지 않는 경우 -->
            <otherwise>
                LOCALTIMESTAMP,  
                LOCALTIMESTAMP
            </otherwise>
        </choose>
    )
	</insert>



	<!-- 조건별  -->





</mapper>