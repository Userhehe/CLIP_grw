<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.clip.gwr.model.mapper.ProjectsDaoImpl">


	<!-- 프로젝트 전체조회 -->
	<select id="getProjectsAll" resultType="ProjectsVo">
		SELECT CLI_NAME,
		PRJ_NAME, PRJ_PROGRESS
		FROM PROJECTS p 
	</select>
	
	<select id="selectClientList" resultType="java.util.Map">
    	SELECT CLI_NAME 
    	FROM CLIENT	
	</select>
	
	<!-- 첫번째 탭 : 진행중/완료 목록 조회 -->
	<select id="getProgressProjects" parameterType="java.util.Map" resultType="ProjectsVo">
		SELECT p.PRJ_ID, p.PRJ_NAME,p.CLI_NAME, p.PRJ_SDATE, p.PRJ_DDATE, p.PRJ_STATUS, p.PRJ_MANAGER, p.PRJ_PROGRESS, pm.USER_ID, u.USER_NAME
		FROM PROJECTS p 
		JOIN PROJECT_MEM pm ON p.PRJ_ID = pm.PRJ_ID
		JOIN USERINFO u ON pm.USER_ID = u.USER_ID
		WHERE 1=1
			<if test="PRJ_STATUS != null and PRJ_STATUS != ''">
			AND PRJ_STATUS = #{PRJ_STATUS}
			</if>
			<if test="CLI_NAME != null and CLI_NAME != ''">
			AND CLI_NAME = #{CLI_NAME}
			</if>
			<if test="PRJ_SDATE != null and PRJ_SDATE != ''">
			AND p.PRJ_SDATE BETWEEN #{PRJ_SDATE} AND #{PRJ_EDATE}
			</if>
			<!-- AND u.USER_ID IN (#{USER_ID}) -->
		ORDER BY p.PRJ_SDATE ASC 
	</select>
	
	<select id="getMemberName" resultType="ProjectMemVo">
		SELECT u.USER_NAME 
		FROM USERINFO u JOIN PROJECT_MEM m
		ON u.USER_ID = m.USER_ID 

	</select>

	<select id="projectsClientSel" resultType="ProjectsVo">
		SELECT PRJ_ID,
		CLI_NAME, PRJ_NAME, PRJ_SDATE, PRJ_DDATE, PRJ_STATUS,
		PRJ_MANAGER,
		PRJ_PROGRESS
		FROM PROJECTS
		WHERE CLI_NAME = #{cli_name}
	</select>

	<!-- 프로젝트 기간별조회 -->
	<select id="projectsPeriodSel" resultType="ProjectsVo">
		SELECT PRJ_ID,
		CLI_NAME, PRJ_NAME, PRJ_SDATE, PRJ_DDATE, PRJ_STATUS,
		PRJ_MANAGER,
		PRJ_PROGRESS
		FROM PROJECTS
		WHERE PRJ_SDATE = #{prj_sdate}
	</select>
	
		<!-- 프로젝트 구성원 입력 -->
	<insert id="pmeminsert" parameterType="java.util.Map">
		INSERT INTO ATTENDS (PRJ_ID, USER_ID, RANKS_NAME, USER_NAME)
			VALUES(
			#{prj_id},#{user_id}, 
			(SELECT RANKS_NAME
					FROM RANKS r 
					JOIN USERINFO u ON r.RANKS_SEQ =u.RANKS_SEQ 
					WHERE u.USER_ID = #{user_id} ),
			(SELECT USER_NAME
					FROM USERINFO
					WHERE USER_ID = #{user_id})	
			)
	</insert>
	
	<!-- 프로젝트 새로등록-->
	<insert id="insertProject" parameterType="java.util.Map">
	INSERT INTO PROJECTS
		(PRJ_ID, CLI_NAME, PRJ_NAME, 
		PRJ_SDATE, PRJ_DDATE, PRJ_MANAGER, 
		WORK_SITE, PRJ_NOTE)
	VALUES(
		'PRJ_' || PROJECTS_SEQ.NEXTVAL, #{cliNm}, #{projectNm}, 
		#{prjSdate}, #{prjEdate}, #{user_id}, 
		#{workSite}, #{prjNote})
	</insert>
	
	<insert id="insertPrjMem" parameterType="java.util.Map">
    <selectKey keyProperty="prj_id" resultType="java.lang.String" order="BEFORE">
        SELECT PROJECTS_SEQ.CURRVAL AS PRJ_ID FROM DUAL
    </selectKey>
    INSERT INTO PROJECT_MEM 
    	(PRM_SEQ, PRJ_ID, USER_ID)
    VALUES 
    	('PRM_' || PROJECTMEM_SEQ.NEXTVAL, 'PRJ_' || #{prj_id}, #{user_id})
</insert>

	<!-- 클라이언트 새로등록-->
	<insert id="insertClient" parameterType="java.util.Map">
	INSERT INTO CLIENT c
		(CLI_NAME, CLI_CONTACT, CLI_ADDRESS,
		CLI_PERSON, CLI_NOTE)
	VALUES(
		#{cliNm}, #{cliNumber}, #{cliAd},
		#{cliMn}, #{cliMnDept})
	</insert>
	
	<!-- 디테일 팝업 조회 -->
	
	<select id="selectDetailList" parameterType="java.lang.String" resultType="ProjectsVo">
		SELECT p.PRJ_ID, p.WORK_SITE, p.PRJ_NAME, p.CLI_NAME, 
		       TO_CHAR(p.PRJ_SDATE, 'YYYY-MM-DD') AS PRJ_SDATE, 
		       TO_CHAR(p.PRJ_DDATE, 'YYYY-MM-DD') AS PRJ_DDATE,
		       p.PRJ_STATUS, 
		       (SELECT u.USER_NAME 
		        FROM USERINFO u 
		        WHERE u.USER_ID = p.PRJ_MANAGER) AS PRJ_MANAGER, 
		       p.PRJ_PROGRESS, 
		       pm.USER_ID, 
		       u.USER_NAME
		FROM PROJECTS p
		JOIN PROJECT_MEM pm ON p.PRJ_ID = pm.PRJ_ID
		JOIN USERINFO u ON pm.USER_ID = u.USER_ID
		WHERE pm.PRJ_ID = #{prjId}
	</select>
</mapper>

